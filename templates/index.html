{% extends "base.html" %}

{% block head %}
<title>Security Scan Dashboard - Home</title>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4>Start New Security Scan</h4>
            </div>
            <div class="card-body">
                <form id="scanForm" action="/start_scan" method="POST" class="row g-3">
                    <div class="col-md-8">
                        <input type="url" class="form-control" id="target_url" name="target_url"
                               placeholder="Enter target URL (e.g., http://example.com)" required>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100" id="scanButton">
                            <span id="scanSpinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            Start Scan
                        </button>
                    </div>
                </form>
                <div id="scanStatus" class="mt-3 d-none">
                    <div class="progress">
                        <div id="scanProgressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="scanStatusText" class="mt-2">Initializing scan...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4>Security Scan Summary</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="riskChart" width="400" height="300"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h5>Risk Level Distribution</h5>
                        <ul class="list-group">
                        {% if chart_data and chart_data.labels %}
                            {% for i in range(chart_data.labels|length) %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ chart_data.labels[i] }}
                                <span class="badge bg-dark rounded-pill">{{ chart_data.data[i] }}</span>
                            </li>
                            {% endfor %}
                        {% else %}
                            <li class="list-group-item">No data available</li>
                        {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4>Recent Scans</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Target URL</th>
                                <th>Date</th>
                                <th>Total Alerts</th>
                                <th>High Risk</th>
                                <th>Medium Risk</th>
                                <th>Low Risk</th>
                                <th>Info</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_scans %}
                                {% for scan in recent_scans %}
                                <tr>
                                    <td>{{ scan.target_url }}</td>
                                    <td>{{ scan.scan_date }}</td>
                                    <td>{{ scan.total_alerts }}</td>
                                    <td class="risk-high">{{ scan.high_risk }}</td>
                                    <td class="risk-medium">{{ scan.medium_risk }}</td>
                                    <td class="risk-low">{{ scan.low_risk }}</td>
                                    <td class="risk-info">{{ scan.info_risk }}</td>
                                    <td>
                                        <a href="/scan/{{ scan.id }}" class="btn btn-sm btn-primary">View Details</a>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="8" class="text-center">No scan data available</td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get the chart data from the server
        const labels = {{ chart_data.labels|default([])|tojson }};
        const data = {{ chart_data.data|default([])|tojson }};
        const colors = {{ chart_data.colors|default([])|tojson }};

        // Only create chart if we have data
        if (labels.length > 0) {
            // Create the donut chart
            const ctx = document.getElementById('riskChart').getContext('2d');
            const riskChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                        },
                        title: {
                            display: true,
                            text: 'Risk Level Distribution'
                        }
                    }
                }
            });
        }

        // Form submission handling with AJAX
        $('#scanForm').on('submit', function(e) {
            e.preventDefault();

            // Show spinner and disable button
            $('#scanButton').attr('disabled', true);
            $('#scanSpinner').removeClass('d-none');
            $('#scanStatus').removeClass('d-none');

            const targetUrl = $('#target_url').val();

            // Start the scan via AJAX
            $.ajax({
                url: '/start_scan',
                type: 'POST',
                data: { target_url: targetUrl },
                dataType: 'json',
                success: function(response) {
                    // Poll for scan status
                    const scanId = response.scan_id;
                    pollScanStatus(scanId);
                },
                error: function(xhr, status, error) {
                    console.error('Error starting scan:', error);
                    $('#scanStatus').html('<div class="alert alert-danger">Failed to start scan: ' + error + '</div>');
                    resetScanButton();
                }
            });
        });

        function pollScanStatus(scanId) {
            const statusInterval = setInterval(function() {
                $.ajax({
                    url: '/scan_status/' + scanId,
                    type: 'GET',
                    dataType: 'json',
                    success: function(response) {
                        // Update progress bar
                        $('#scanProgressBar').css('width', response.progress + '%');
                        $('#scanStatusText').text(response.status);

                        if (response.completed) {
                            clearInterval(statusInterval);
                            $('#scanStatus').html('<div class="alert alert-success">Scan completed successfully! <a href="/scan/' + response.scan_db_id + '">View Results</a></div>');
                            resetScanButton();
                            // Reload the page to show updated scan list
                            setTimeout(function() {
                                window.location.reload();
                            }, 2000);
                        }
                    },
                    error: function(xhr, status, error) {
                        clearInterval(statusInterval);
                        $('#scanStatus').html('<div class="alert alert-danger">Error checking scan status: ' + error + '</div>');
                        resetScanButton();
                    }
                });
            }, 5000); // Poll every 5 seconds
        }

        function resetScanButton() {
            $('#scanButton').attr('disabled', false);
            $('#scanSpinner').addClass('d-none');
        }
    });
</script>
{% endblock %}
