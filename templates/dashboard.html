{% extends "base.html" %}

{% block head %}
<title>Security Scan Dashboard - Enhanced</title>
<style>
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    .stat-card h3 {
        font-size: 2.5rem;
        margin: 0;
    }
    .search-bar {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    .alert-badge {
        font-size: 0.8rem;
        padding: 0.5rem 1rem;
    }
    .scan-item {
        border-left: 4px solid #007bff;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }
    .scan-item:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<!-- Statistics Cards -->
<div class="row mb-4" id="statsCards">
    <!-- Statistics will be loaded here -->
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card search-bar">
            <div class="card-body">
                <h5>Search & Filter</h5>
                <div class="row">
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search alerts...">
                    </div>
                    <div class="col-md-3">
                        <select class="form-control" id="riskFilter">
                            <option value="">All Risk Levels</option>
                            <option value="High">High Risk</option>
                            <option value="Medium">Medium Risk</option>
                            <option value="Low">Low Risk</option>
                            <option value="Informational">Informational</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control" id="dateFilter">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="performSearch()">Search</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4>Quick Actions</h4>
            </div>
            <div class="card-body">
               
                <button class="btn btn-info me-2" onclick="refreshDashboard()">
                    <i class="fas fa-sync"></i> Refresh Data
                </button>
                <button class="btn btn-warning me-2" onclick="showScanHistory()">
                    <i class="fas fa-history"></i> Scan History
                </button>
                <input type="file" id="importFile" accept=".csv" style="display: none;" onchange="importAlerts()">
                <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">
                    <i class="fas fa-upload"></i> Import Alerts
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Alerts Table -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h4>Security Alerts</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="alertsTable" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Alert Name</th>
                                <th>Risk Level</th>
                                <th>URL</th>
                                <th>CWE ID</th>
                                <th>Confidence</th>
                                <th>Scan Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <!-- Alerts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scan History Modal -->
<div class="modal fade" id="scanHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scan History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="scanHistoryContent">
                    <!-- Scan history will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadAlerts();

    // Set up search input with debouncing
    let searchTimeout;
    document.getElementById('searchInput').addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
    });
});

function loadStatistics() {
    fetch('/api/statistics')
        .then(response => response.json())
        .then(data => {
            const statsCards = document.getElementById('statsCards');
            statsCards.innerHTML = `
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3>${data.total_scans}</h3>
                        <p>Total Scans</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3>${data.total_alerts}</h3>
                        <p>Total Alerts</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3>${data.high_risk_alerts}</h3>
                        <p>High Risk Alerts</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card">
                        <h3>${data.recent_scans}</h3>
                        <p>Recent Scans (7 days)</p>
                    </div>
                </div>
            `;
        })
        .catch(error => console.error('Error loading statistics:', error));
}

function loadAlerts() {
    fetch('/api/alerts')
        .then(response => response.json())
        .then(alerts => {
            const tbody = document.getElementById('alertsTableBody');
            tbody.innerHTML = '';

            alerts.forEach(alert => {
                const row = document.createElement('tr');
                const riskBadge = getRiskBadge(alert.risk_level);

                row.innerHTML = `
                    <td>${alert.alert_name}</td>
                    <td>${riskBadge}</td>
                    <td><small>${alert.url}</small></td>
                    <td>${alert.cwe_id || 'N/A'}</td>
                    <td>${alert.confidence}</td>
                    <td>${formatDate(alert.scan_date)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showAlertDetails(${alert.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => console.error('Error loading alerts:', error));
}

function getRiskBadge(riskLevel) {
    const badges = {
        'High': '<span class="badge bg-danger alert-badge">High</span>',
        'Medium': '<span class="badge bg-warning alert-badge">Medium</span>',
        'Low': '<span class="badge bg-info alert-badge">Low</span>',
        'Informational': '<span class="badge bg-secondary alert-badge">Info</span>'
    };
    return badges[riskLevel] || '<span class="badge bg-secondary alert-badge">Unknown</span>';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

function performSearch() {
    const searchTerm = document.getElementById('searchInput').value;
    const riskLevel = document.getElementById('riskFilter').value;

    let url = '/api/alerts/search?q=' + encodeURIComponent(searchTerm);
    if (riskLevel) {
        url += '&risk_level=' + encodeURIComponent(riskLevel);
    }

    fetch(url)
        .then(response => response.json())
        .then(alerts => {
            const tbody = document.getElementById('alertsTableBody');
            tbody.innerHTML = '';

            alerts.forEach(alert => {
                const row = document.createElement('tr');
                const riskBadge = getRiskBadge(alert.risk_level);

                row.innerHTML = `
                    <td>${alert.alert_name}</td>
                    <td>${riskBadge}</td>
                    <td><small>${alert.url}</small></td>
                    <td>${alert.cwe_id || 'N/A'}</td>
                    <td>${alert.confidence}</td>
                    <td>${formatDate(alert.scan_date)}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="showAlertDetails(${alert.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => console.error('Error searching alerts:', error));
}

function exportAlerts() {
    window.location.href = '/export_alerts';
}

function importAlerts() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];

    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    fetch('/import_alerts', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Alerts imported successfully!');
            loadAlerts();
            loadStatistics();
        } else {
            alert('Error importing alerts: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error importing alerts:', error);
        alert('Error importing alerts');
    });
}

function refreshDashboard() {
    loadStatistics();
    loadAlerts();
}

function showScanHistory() {
    fetch('/api/scans')
        .then(response => response.json())
        .then(scans => {
            const content = document.getElementById('scanHistoryContent');
            content.innerHTML = '';

            scans.forEach(scan => {
                const scanDiv = document.createElement('div');
                scanDiv.className = 'card scan-item mb-2';
                scanDiv.innerHTML = `
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>${scan.target_url}</strong><br>
                                <small class="text-muted">${formatDate(scan.scan_date)}</small>
                            </div>
                            <div class="col-md-4">
                                <span class="badge bg-primary">Total: ${scan.total_alerts}</span>
                                <span class="badge bg-danger">High: ${scan.high_risk}</span>
                                <span class="badge bg-warning">Medium: ${scan.medium_risk}</span>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-primary" onclick="viewScanDetails(${scan.id})">
                                    View
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteScan(${scan.id})">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                content.appendChild(scanDiv);
            });

            const modal = new bootstrap.Modal(document.getElementById('scanHistoryModal'));
            modal.show();
        })
        .catch(error => console.error('Error loading scan history:', error));
}

function viewScanDetails(scanId) {
    window.location.href = '/scan/' + scanId;
}

function deleteScan(scanId) {
    if (confirm('Are you sure you want to delete this scan?')) {
        fetch('/api/scan/' + scanId + '/delete', {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Scan deleted successfully!');
                showScanHistory();
                loadStatistics();
                loadAlerts();
            } else {
                alert('Error deleting scan: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error deleting scan:', error);
            alert('Error deleting scan');
        });
    }
}

function showAlertDetails(alertId) {
    // This could be expanded to show a modal with full alert details
    alert('Alert details for ID: ' + alertId);
}
</script>
{% endblock %}
